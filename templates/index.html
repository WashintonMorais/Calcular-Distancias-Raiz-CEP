<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel de Distâncias por Raiz de CEP</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Adiciona uma transição suave para a barra de progresso */
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-7xl mx-auto space-y-8">

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">Calcular Distâncias por Raiz de CEP</h1>
            <form id="calculo-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <input name="cep_partida" placeholder="CEP de Partida (ex: 37416590)" required class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500" />
                    <input name="raiz_inicial" placeholder="Raiz Inicial (ex: 37410)" required class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500" />
                    <input name="raiz_final" placeholder="Raiz Final (ex: 37418)" required class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500" />
                </div>
                <button id="submit-button" class="bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700 transition w-full sm:w-auto disabled:bg-gray-400" type="submit">
                    <span id="button-text">Calcular Distâncias</span>
                    <span id="button-spinner" class="hidden">Calculando...</span>
                </button>
            </form>
        </div>

        <div id="status-container" class="space-y-8 hidden">

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Progresso</h2>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div id="progress-text" class="text-right text-sm text-gray-600 mt-1">0%</div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Log de Execução</h2>
                <pre id="log" class="bg-gray-800 text-white text-xs rounded p-4 h-64 overflow-y-scroll font-mono"></pre>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Resultados Consolidados</h2>
                    <a id="download-link" href="#" class="hidden mt-2 sm:mt-0 bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700 transition">
                        Baixar Relatório (.CSV)
                    </a>
                </div>
                <div class="overflow-x-auto">
                    <table class="table-auto w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-gray-200 text-left">
                                <th class="border-b p-3">Raiz de CEP</th>
                                <th class="border-b p-3">Bairro</th>
                                <th class="border-b p-3">Distância Média (km)</th>
                                <th class="border-b p-3">Tempo Estimado (min)</th>
                            </tr>
                        </thead>
                        <tbody id="resultados-body">
                            <tr id="no-results-row">
                                <td colspan="4" class="text-center p-8 text-gray-500">Nenhum resultado para exibir ainda.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Selecionando os elementos do DOM para reutilização
        const calculoForm = document.getElementById('calculo-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        const statusContainer = document.getElementById('status-container');
        const logElement = document.getElementById('log');
        const resultadosBody = document.getElementById('resultados-body');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const downloadLink = document.getElementById('download-link');
        const noResultsRow = document.getElementById('no-results-row');

        calculoForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Impede o envio padrão do formulário

            // --- 1. PREPARA A INTERFACE PARA O CÁLCULO ---
            statusContainer.classList.remove('hidden');
            logElement.textContent = 'Iniciando conexão com o servidor...';
            resultadosBody.innerHTML = ''; // Limpa resultados anteriores
            resultadosBody.appendChild(noResultsRow); // Adiciona a linha "sem resultados"
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            downloadLink.classList.add('hidden');
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            buttonSpinner.classList.remove('hidden');

            // --- 2. MONTA A URL E INICIA A CONEXÃO SSE ---
            const formData = new FormData(event.target);
            const params = new URLSearchParams(formData);
            const eventSource = new EventSource(`/stream-calculo?${params.toString()}`);

            logElement.textContent += '\nConexão estabelecida. Aguardando dados...';

            // --- 3. DEFINE O QUE FAZER QUANDO UMA MENSAGEM CHEGA ---
            eventSource.onmessage = function(e) {
                const data = JSON.parse(e.data);

                if (data.tipo === 'log') {
                    // Atualiza o log e a barra de progresso
                    logElement.textContent += '\n' + data.msg;
                    logElement.scrollTop = logElement.scrollHeight;
                    progressBar.style.width = data.progresso + '%';
                    progressText.textContent = data.progresso + '%';
                } 
                else if (data.tipo === 'fim') {
                    // Processo finalizado, preenche a tabela
                    noResultsRow.remove(); // Remove a linha de "sem resultados"
                    logElement.textContent += '\n\n✅ Processo concluído!';
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';

                    data.resultados.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'odd:bg-white even:bg-gray-50';
                        row.innerHTML = `
                            <td class="border-b p-3">${item.raiz}</td>
                            <td class="border-b p-3">${item.bairro}</td>
                            <td class="border-b p-3">${item.distancia}</td>
                            <td class="border-b p-3">${item.tempo}</td>
                        `;
                        resultadosBody.appendChild(row);
                    });
                    
                    // Mostra link de download, reativa o botão e fecha a conexão
                    downloadLink.href = data.download_link;
                    downloadLink.classList.remove('hidden');
                    resetUI();
                    eventSource.close();
                }
                else if (data.tipo === 'erro') {
                    logElement.textContent += '\n\n❌ ERRO: ' + data.msg;
                    resetUI();
                    eventSource.close();
                }
            };

            // --- 4. DEFINE O QUE FAZER EM CASO DE ERRO DE CONEXÃO ---
            eventSource.onerror = function() {
                logElement.textContent += '\n\n❌ Erro de conexão com o servidor. A conexão foi perdida.';
                resetUI();
                eventSource.close();
            };
        });

        function resetUI() {
            submitButton.disabled = false;
            buttonText.classList.remove('hidden');
            buttonSpinner.classList.add('hidden');
        }
    </script>
</body>
</html>