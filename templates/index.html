<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel de Distâncias por Raiz de CEP</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        #progress-bar { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-7xl mx-auto space-y-8">

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">Calcular Distâncias por Raiz de CEP</h1>
            <form id="calculo-form" class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <input name="cep_partida" placeholder="CEP de Partida (8 dígitos)" required maxlength="8" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500" />
                    <input name="raiz_inicial" placeholder="Raiz Inicial (5 dígitos)" required maxlength="5" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500" />
                    <input name="raiz_final" placeholder="Raiz Final (5 dígitos)" required maxlength="5" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Consulta</label>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex items-center">
                            <input id="tipo_detalhada" name="tipo_consulta" type="radio" value="detalhada" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="tipo_detalhada" class="ml-3 block text-sm text-gray-900">Consulta Detalhada <span class="text-gray-500">(Lenta, por bairro)</span></label>
                        </div>
                        <div class="flex items-center">
                            <input id="tipo_rapida" name="tipo_consulta" type="radio" value="rapida" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="tipo_rapida" class="ml-3 block text-sm text-gray-900">Consulta Rápida <span class="text-gray-500">(Centro da Raiz)</span></label>
                        </div>
                    </div>
                </div>
                <button id="submit-button" class="bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700 transition w-full sm:w-auto disabled:bg-gray-400" type="submit">
                    <span id="button-text">Calcular Distâncias</span>
                    <span id="button-spinner" class="hidden">Calculando...</span>
                </button>
            </form>
        </div>

        <div id="status-container" class="space-y-8 hidden">
            <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-3">Progresso</h2><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div></div><div id="progress-text" class="text-right text-sm text-gray-600 mt-1">0%</div></div>
            <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-3">Log de Execução</h2><pre id="log" class="bg-gray-800 text-white text-xs rounded p-4 h-64 overflow-y-scroll font-mono"></pre></div>
            <div class="bg-white p-6 rounded-lg shadow-md"><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4"><h2 class="text-xl font-semibold text-gray-700">Resultados Consolidados</h2><a id="download-link" href="#" class="hidden mt-2 sm:mt-0 bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700 transition">Baixar Relatório (.CSV)</a></div><div class="overflow-x-auto"><table class="table-auto w-full border-collapse text-sm"><thead><tr class="bg-gray-200 text-left"><th class="border-b p-3">Raiz de CEP</th><th class="border-b p-3">Bairro / Descrição</th><th class="border-b p-3">Distância Média (km)</th><th class="border-b p-3">Tempo Estimado (min)</th><th class="border-b p-3">CEPs / Amostras</th></tr></thead><tbody id="resultados-body"><tr id="no-results-row"><td colspan="5" class="text-center p-8 text-gray-500">Nenhum resultado para exibir ainda.</td></tr></tbody></table></div></div>
        </div>
    </div>

    <script>
        const calculoForm = document.getElementById('calculo-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        const statusContainer = document.getElementById('status-container');
        const logElement = document.getElementById('log');
        const resultadosBody = document.getElementById('resultados-body');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const downloadLink = document.getElementById('download-link');

        // --- NOVA LÓGICA DE ORQUESTRAÇÃO ---
        let jobQueue = [];
        let globalResults = [];

        function resetUI() {
            submitButton.disabled = false;
            buttonText.classList.remove('hidden');
            buttonSpinner.classList.add('hidden');
        }
        
        function startNextJob() {
            if (jobQueue.length === 0) {
                logElement.textContent += '\n\n✅ Processo concluído!';
                // Atualizar link de download e reativar botão no final de tudo
                // (Esta parte precisa ser implementada se o download geral for necessário)
                resetUI();
                return;
            }

            const job = jobQueue.shift(); // Pega o próximo trabalho da fila
            const params = new URLSearchParams(job);
            const eventSource = new EventSource(`/stream-calculo?${params.toString()}`);
            
            logElement.textContent += `\n\n--- Iniciando cálculo para raiz: ${job.raiz_inicial} ---`;

            eventSource.onmessage = function(e) {
                const data = JSON.parse(e.data);

                if (data.tipo === 'log') {
                    logElement.textContent += '\n' + data.msg;
                    logElement.scrollTop = logElement.scrollHeight;
                    // A barra de progresso agora reflete o progresso do job atual
                    progressBar.style.width = data.progresso + '%';
                    progressText.textContent = `Raiz ${job.raiz_inicial}: ${data.progresso}%`;
                } 
                else if (data.tipo === 'fim') {
                    const noResultsRow = document.getElementById('no-results-row');
                    if (noResultsRow) noResultsRow.remove();

                    data.resultados.forEach(item => {
                        globalResults.push(item); // Salva os resultados globais se precisar
                        const row = document.createElement('tr');
                        row.className = item.tipo_linha === 'resumo_raiz' ? 'bg-blue-100 font-bold' : 'odd:bg-white even:bg-gray-50';
                        row.innerHTML = `<td class="border-b p-3">${item.raiz}</td><td class="border-b p-3">${item.bairro}</td><td class="border-b p-3">${item.distancia}</td><td class="border-b p-3">${item.tempo}</td><td class="border-b p-3">${item.ceps_consultados}</td>`;
                        resultadosBody.appendChild(row);
                    });
                    
                    eventSource.close();
                    startNextJob(); // Inicia o próximo trabalho
                }
                else if (data.tipo === 'erro') {
                    logElement.textContent += `\n\n❌ ERRO na raiz ${job.raiz_inicial}: ${data.msg}`;
                    eventSource.close();
                    startNextJob(); // Tenta o próximo trabalho mesmo se um falhar
                }
            };

            eventSource.onerror = function() {
                logElement.textContent += `\n\n❌ Erro de conexão com o servidor ao processar a raiz ${job.raiz_inicial}.`;
                eventSource.close();
                startNextJob(); // Tenta o próximo
            };
        }

        calculoForm.addEventListener('submit', function(event) {
            event.preventDefault();

            // 1. PREPARA A INTERFACE
            statusContainer.classList.remove('hidden');
            logElement.textContent = 'Preparando os cálculos...';
            resultadosBody.innerHTML = '<tr id="no-results-row"><td colspan="5" class="text-center p-8 text-gray-500">Aguardando resultados...</td></tr>';
            downloadLink.classList.add('hidden');
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            buttonSpinner.classList.remove('hidden');

            // 2. CRIA A FILA DE TRABALHOS
            jobQueue = [];
            globalResults = [];
            const formData = new FormData(event.target);
            const cepPartida = formData.get('cep_partida');
            const raizInicial = parseInt(formData.get('raiz_inicial'));
            const raizFinal = parseInt(formData.get('raiz_final'));
            const tipoConsulta = formData.get('tipo_consulta');

            for (let raiz = raizInicial; raiz <= raizFinal; raiz++) {
                jobQueue.push({
                    cep_partida: cepPartida,
                    raiz_inicial: raiz,
                    raiz_final: raiz, // Cada job processa uma única raiz
                    tipo_consulta: tipoConsulta
                });
            }

            // 3. INICIA O PRIMEIRO TRABALHO
            startNextJob();
        });
    </script>
</body>
</html>